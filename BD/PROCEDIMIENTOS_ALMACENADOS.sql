#USAR LA BD PARA LA CREACION
USE MAIPO_GRANDE;
#ELIMINAR PROCEDIMIENTOS EXISTENTES

#CREACION DE PROCEDIMIENTOS

#PROCEDIMIENTO DE CREACION DE USUARIOS
DROP PROCEDURE IF EXISTS SP_CREATE_USUARIO;
DELIMITER //
CREATE PROCEDURE SP_CREATE_USUARIO(
IN $NOMBRE VARCHAR(100),
IN $APELLIDO VARCHAR(100),
IN $RUT INT(8),
IN $DV CHAR(1),
IN $COMUNA INT,
IN $CODIGO_POSTAL INT,
IN $CORREO VARCHAR(100),
IN $CONTRASENA VARCHAR(250),
IN $TELEFONO INT(11),
IN $ID_TIPO_PERSONA INT(11),
IN $NOMBRE_FANTASIA VARCHAR(100),
IN $ID_PERFIL INT(11))
BEGIN
	DECLARE $ID_USUARIO INT;
	#SE CREA NUEVO USUARIO
    INSERT INTO `maipo_grande`.`usuario`
	(`CORREO`,
	`CONTRASENA`,
	`ID_PERFIL`)
	VALUES
	($CORREO,
	$CONTRASENA,
	$ID_PERFIL); 
	#SE OBTIENE ID DE USUARIO CREADO
    SELECT MAX(ID_USUARIO) INTO $ID_USUARIO FROM `maipo_grande`.`usuario`;
    #SE INSERTAN DATOS DE PERSONA, CON EL ID DE USUARIO OBTENIDO
    INSERT INTO `maipo_grande`.`persona`
	(`ID_USUARIO`,
	`RUT`,
	`DIGITO_VERIFICADOR`,
	`NOMBRE`,
	`APELLIDO`,
	`NOMBRE_FANTASIA`,
	`CODIGO_POSTAL`,
	`ID_COMUNA`,
	`TELEFONO`,
	`ID_TIPO_PERSONA_LEGAL`)
	VALUES
	($ID_USUARIO,
	$RUT,
	$DV,
	$NOMBRE,
	$APELLIDO,
	$NOMBRE_FANTASIA,
	$CODIGO_POSTAL,
	$COMUNA,
	$TELEFONO,
	$ID_TIPO_PERSONA);
END //
DELIMITER ;

#PROCEDIMIENTO PARA TRAER COMUNAS
DROP PROCEDURE IF EXISTS SP_GET_CATALOGO;
DELIMITER //
CREATE PROCEDURE SP_GET_COMUNAS()
BEGIN
SELECT ID_COMUNA ID, ID_CIUDAD CIUDAD, NOMBRE NOMBRECOMUNA FROM COMUNA;
END //
DELIMITER ;

#PROCEDIMIENTO CON OFERTAS PARA CATALOGO, SEGUN ROL
DROP PROCEDURE IF EXISTS SP_GET_CATALOGO;
DELIMITER //
CREATE PROCEDURE SP_GET_CATALOGO()
BEGIN
	SELECT 
	CONCAT(PU.NOMBRE,' ',PU.APELLIDO) NOMBRE_VENDEDOR,
	TF.NOMBRE TIPO_FRUTA,
	C.NOMBRE CALIDAD,
	DP.CANT_KG,
	P.FECHA_CREACION ,
    TF.FOTO FOTO,
    DP.PRECIO_KG PRECIO,
    DP.COD_MONEDA MONEDA,
    P.ID_PEDIDO ID
	FROM PEDIDO P
	JOIN PERSONA PU ON PU.ID_USUARIO=P.ID_COMPRADOR
	JOIN DETALLE_PEDIDO DP ON P.ID_PEDIDO=DP.ID_PEDIDO
	JOIN CALIDAD C ON C.ID_CALIDAD=DP.ID_CALIDAD
	JOIN TIPO_FRUTA TF ON TF.ID_TIPO_FRUTA=DP.ID_TIPO_FRUTA
	WHERE ID_ESTADO_PEDIDO IN (2);
END //
DELIMITER ;

#PROCEDIMIENTO CON TIPOS DE FRUTA
DROP PROCEDURE IF EXISTS SP_GET_TIPO_FRUTA;
DELIMITER //
CREATE PROCEDURE SP_GET_TIPO_FRUTA()
BEGIN
	SELECT 
    ID_TIPO_FRUTA, NOMBRE TIPO_FRUTA, DESCRIPCION
	FROM TIPO_FRUTA TF;
END //
DELIMITER ;

#PROCEDIMIENTO CON TIPOS DE CALIDAD
DROP PROCEDURE IF EXISTS SP_GET_CALIDAD;
DELIMITER //
CREATE PROCEDURE SP_GET_CALIDAD()
BEGIN
	SELECT 
    ID_CALIDAD, NOMBRE CALIDAD
	FROM calidad TF;
END //
DELIMITER ;


#PROCEDIMIENTO PARA ELIMINAR USUARIO
DROP PROCEDURE IF EXISTS SP_DELETE_USUARIO;
DELIMITER //
CREATE PROCEDURE SP_DELETE_USUARIO($RUT VARCHAR(8))
BEGIN
	DECLARE $ID_USUARIO INT;
    DECLARE $ID_PEDIDO INT;
	#SE RECUPERA ID DEL USUARIO
    SELECT 
    ID_USUARIO INTO $ID_USUARIO
	FROM PERSONA
    WHERE RUT = $RUT;
    #SE ELMINA DATOS DE PERSONA DEL USUARIO
    #SE RECUPERA EL ID DE LOS PEDIDOS ASOCIADOS AL USUARIO
	SELECT
    ID_PEDIDO INTO $ID_PEDIDO
    FROM PEDIDO
    WHERE ID_COMPRADOR = $ID_USUARIO;
    #SE ELIMINAN LOS PEDIDOS ASOCIADOS AL USUARIO
    DELETE
    FROM DETALLE_PEDIDO
    WHERE ID_PEDIDO = $ID_PEDIDO;
    DELETE
    FROM PEDIDO
    WHERE ID_COMPRADOR = $ID_USUARIO;
	#SE ELIMINAN LOS DESPACHOS ASOCIADOS AL USUARIO, SI ES TRANSPORTISTA
	DELETE
    FROM DESPACHO
    WHERE ID_TRANSPORTISTA = $ID_USUARIO;
    DELETE
    #SE ELIMINA LA PERSONA ASOCIADA AL USUARIO
    FROM PERSONA
    WHERE ID_USUARIO = $ID_USUARIO;
    #SE ELIMINA USUARIO
	DELETE
    FROM USUARIO
    WHERE ID_USUARIO = $ID_USUARIO;
END
DELIMITER ;


#PROCEDIMIENTO PARA MODIFICAR USUARIO
DROP PROCEDURE IF EXISTS SP_UPDATE_USUARIO;
DELIMITER //
CREATE PROCEDURE SP_UPDATE_USUARIO(
$NOMBRE VARCHAR(100),
$APELLIDO VARCHAR(100),
$RUT INT(8),
$TIPO_PERFIL INT,
$TIPO_PERSONA INT,
$NOMBRE_FANTASIA VARCHAR(100),
$COMUNA INT,
$CODIGO_POSTAL INT,
$TELEFONO INT,
$CORREO VARCHAR(100),
$CONTRASENA VARCHAR(255)
)
BEGIN
	DECLARE $ID_USUARIO INT;
    #OBTENER ID DE USUARIO
    SELECT
    ID_USUARIO INTO $ID_USUARIO
    FROM PERSONA
    WHERE RUT=$RUT;
    #ACTUALIZAR DATOS PERSONA
    UPDATE PERSONA SET
    RUT = $RUT,
    NOMBRE = $NOMBRE,
    APELLIDO = $APELLIDO,
    NOMBRE_FANTASIA = NOMBRE_FANTASIA,
    CODIGO_POSTAL = $CODIGO_POSTAL,
    ID_COMUNA = $COMUNA,
    TELEFONO = $TELEFONO,
    ID_TIPO_PERSONA_LEGAL = $TIPO_PERSONA;
    #ACTUALIZAR DATOS USUARIO
    UPDATE USUARIO SET
    CORREO = $CORREO,
    CONTRASENA = $CONTRASENA,
    ID_PERFIL = $TIPO_PERFIL;
END
DELIMITER ;

##CREAR PRODUCTO TIPO FRUTA
DROP PROCEDURE IF EXISTS SP_CREATE_TIPO_FRUTA;
DELIMITER //
CREATE PROCEDURE `SP_CREATE_TIPO_FRUTA`(
IN $NOMBRE VARCHAR(100),
IN $DESCRIPCION VARCHAR(150),
IN $FOTO BLOB)
BEGIN
INSERT INTO `maipo_grande`.`tipo_fruta`
	(`NOMBRE`,
	`DESCRIPCION`,
	`FOTO`)
    VALUES
    ($NOMBRE,
    $DESCRIPCION,
    $FOTO);
END
DELIMITER ;

##ELIMINAR PRODUCTO TIPO FRUTA
DROP PROCEDURE IF EXISTS SP_DELETE_TIPO_FRUTA;
DELIMITER //
CREATE PROCEDURE `SP_DELETE_TIPO_FRUTA`($ID_TIPO_FRUTA INT)
BEGIN
DELETE FROM TIPO_FRUTA WHERE ID_TIPO_FRUTA = $ID_TIPO_FRUTA;
END
DELIMITER ;

##ACTUALIZAR PRODUCTO TIPO FRUTA
DROP PROCEDURE IF EXISTS SP_UPDATE_TIPO_FRUTA;
DELIMITER //
CREATE PROCEDURE `SP_UPDATE_TIPO_FRUTA`(
$ID_TIPO_FRUTA INT,
$NOMBRE VARCHAR(100),
$DESCRIPCION VARCHAR(150),
$FOTO BLOB)
BEGIN

    UPDATE TIPO_FRUTA 
    SET
    NOMBRE = $NOMBRE,
    DESCRIPCION = $DESCRIPCION,
    FOTO = $FOTO
    WHERE ID_TIPO_FRUTA = $ID_TIPO_FRUTA;
END
DELIMITER ;

##LISTAR USUARIOS
DROP PROCEDURE IF EXISTS SP_GET_USUARIO;
DELIMITER //
CREATE PROCEDURE `SP_GET_USUARIO`()
BEGIN
SELECT U.ID_USUARIO ID_USUARIO,P.RUT,P.DIGITO_VERIFICADOR,P.NOMBRE,P.APELLIDO,P.TELEFONO,P.ID_TIPO_PERSONA_LEGAL,P.NOMBRE_FANTASIA,
P.CODIGO_POSTAL,P.ID_COMUNA,U.CORREO,U.ID_PERFIL FROM PERSONA P 
JOIN USUARIO U on U.ID_USUARIO = P.ID_USUARIO
ORDER BY U.ID_USUARIO ;
END
DELIMITER ;


#CREAR VENTA INTERNA
DROP PROCEDURE IF EXISTS SP_CREAR_VENTA_INTERNA;
DELIMITER //
CREATE PROCEDURE `SP_CREAR_VENTA_INTERNA`(
IN $ID_PROVEEDOR INT,
IN $ID_TIPO_FRUTA INT,
IN $ID_CALIDAD INT,
IN $CANT_KG float(6,3),
IN $PRECIO_X_KG float(9,3))
BEGIN
INSERT INTO HISTORICO_STOCK(ID_PROVEEDOR,ID_TIPO_FRUTA,ID_CALIDAD,FECHA_REGISTRO,CANT_KG,PRECIO_X_KG)
VALUES($ID_PROVEEDOR, 
$ID_TIPO_FRUTA, 
$ID_CALIDAD, 
SYSDATE(), 
$CANT_KG, 
$PRECIO_X_KG);
END
DELIMITER ;