#USAR LA BD PARA LA CREACION
USE MAIPO_GRANDE;
#ELIMINAR PROCEDIMIENTOS EXISTENTES

#CREACION DE PROCEDIMIENTOS

#PROCEDIMIENTO DE CREACION DE USUARIOS
DROP PROCEDURE IF EXISTS SP_CREATE_USUARIO;
DELIMITER //
CREATE PROCEDURE SP_CREATE_USUARIO(
IN $NOMBRE VARCHAR(100),
IN $APELLIDO VARCHAR(100),
IN $RUT INT(8),
IN $DV CHAR(1),
IN $COMUNA INT,
IN $CODIGO_POSTAL INT,
IN $CORREO VARCHAR(100),
IN $CONTRASENA VARCHAR(250),
IN $TELEFONO INT(11),
IN $ID_TIPO_PERSONA INT(11),
IN $NOMBRE_FANTASIA VARCHAR(100),
IN $ID_PERFIL INT(11))
BEGIN
	DECLARE $ID_USUARIO INT;
	#SE CREA NUEVO USUARIO
    INSERT INTO `maipo_grande`.`usuario`
	(`CORREO`,
	`CONTRASENA`,
	`ID_PERFIL`)
	VALUES
	($CORREO,
	$CONTRASENA,
	$ID_PERFIL); 
	#SE OBTIENE ID DE USUARIO CREADO
    SELECT MAX(ID_USUARIO) INTO $ID_USUARIO FROM `maipo_grande`.`usuario`;
    #SE INSERTAN DATOS DE PERSONA, CON EL ID DE USUARIO OBTENIDO
    INSERT INTO `maipo_grande`.`persona`
	(`ID_USUARIO`,
	`RUT`,
	`DIGITO_VERIFICADOR`,
	`NOMBRE`,
	`APELLIDO`,
	`NOMBRE_FANTASIA`,
	`CODIGO_POSTAL`,
	`ID_COMUNA`,
	`TELEFONO`,
	`ID_TIPO_PERSONA_LEGAL`)
	VALUES
	($ID_USUARIO,
	$RUT,
	$DV,
	$NOMBRE,
	$APELLIDO,
	$NOMBRE_FANTASIA,
	$CODIGO_POSTAL,
	$COMUNA,
	$TELEFONO,
	$ID_TIPO_PERSONA);
END //
DELIMITER ;

#PROCEDIMIENTO PARA TRAER COMUNAS
DROP PROCEDURE IF EXISTS SP_GET_CATALOGO;
DELIMITER //
CREATE PROCEDURE SP_GET_COMUNAS()
BEGIN
SELECT ID_COMUNA ID, ID_CIUDAD CIUDAD, NOMBRE NOMBRECOMUNA FROM COMUNA;
END //
DELIMITER ;

#PROCEDIMIENTO CON OFERTAS PARA CATALOGO, SEGUN ROL
DROP PROCEDURE IF EXISTS SP_GET_CATALOGO;
DELIMITER //
CREATE PROCEDURE SP_GET_CATALOGO()
BEGIN
	SELECT 
	CONCAT(PU.NOMBRE,' ',PU.APELLIDO) NOMBRE_VENDEDOR,
	TF.NOMBRE TIPO_FRUTA,
	C.NOMBRE CALIDAD,
	DP.CANT_KG,
	P.FECHA_CREACION ,
    TF.FOTO FOTO,
    DP.PRECIO_KG PRECIO,
    DP.COD_MONEDA MONEDA,
    P.ID_PEDIDO ID
	FROM PEDIDO P
	JOIN PERSONA PU ON PU.ID_USUARIO=P.ID_COMPRADOR
	JOIN DETALLE_PEDIDO DP ON P.ID_PEDIDO=DP.ID_PEDIDO
	JOIN CALIDAD C ON C.ID_CALIDAD=DP.ID_CALIDAD
	JOIN TIPO_FRUTA TF ON TF.ID_TIPO_FRUTA=DP.ID_TIPO_FRUTA
	WHERE ID_ESTADO_PEDIDO IN (2)
	AND ID_TIPO_PEDIDO=2;
END //
DELIMITER ;

#PROCEDIMIENTO CON TIPOS DE FRUTA
DROP PROCEDURE IF EXISTS SP_GET_TIPO_FRUTA;
DELIMITER //
CREATE PROCEDURE SP_GET_TIPO_FRUTA()
BEGIN
	SELECT 
    NOMBRE TIPO_FRUTA
	FROM TIPO_FRUTA TF;
END //
DELIMITER ;

#PROCEDIMIENTO CON TIPOS DE CALIDAD
DROP PROCEDURE IF EXISTS SP_GET_CALIDAD;
DELIMITER //
CREATE PROCEDURE SP_GET_CALIDAD()
BEGIN
	SELECT 
    NOMBRE CALIDAD
	FROM calidad TF;
END //
DELIMITER ;


#PROCEDIMIENTO PARA ELIMINAR USUARIO
DROP PROCEDURE IF EXISTS SP_DELETE_USUARIO;
DELIMITER //
CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_DELETE_USUARIO`($RUT VARCHAR(8))
BEGIN
	DECLARE $ID_USUARIO INT;
    DECLARE $ID_PEDIDO INT;
	#SE RECUPERA ID DEL USUARIO
    SELECT 
    ID_USUARIO INTO $ID_USUARIO
	FROM PERSONA
    WHERE RUT = $RUT;
    #SE ELMINA DATOS DE PERSONA DEL USUARIO
    #SE RECUPERA EL ID DE LOS PEDIDOS ASOCIADOS AL USUARIO
	SELECT
    ID_PEDIDO INTO $ID_PEDIDO
    FROM PEDIDO
    WHERE ID_COMPRADOR = $ID_USUARIO;
    #SE ELIMINAN LOS PEDIDOS ASOCIADOS AL USUARIO
    DELETE
    FROM DETALLE_PEDIDO
    WHERE ID_PEDIDO = $ID_PEDIDO;
    DELETE
    FROM PEDIDO
    WHERE ID_COMPRADOR = $ID_USUARIO;
	#SE ELIMINAN LOS DESPACHOS ASOCIADOS AL USUARIO, SI ES TRANSPORTISTA
	DELETE
    FROM DESPACHO
    WHERE ID_TRANSPORTISTA = $ID_USUARIO;
    DELETE
    #SE ELIMINA LA PERSONA ASOCIADA AL USUARIO
    FROM PERSONA
    WHERE ID_USUARIO = $ID_USUARIO;
    #SE ELIMINA USUARIO
	DELETE
    FROM USUARIO
    WHERE ID_USUARIO = $ID_USUARIO;
END
DELIMITER ;


#PROCEDIMIENTO PARA MODIFICAR USUARIO
DROP PROCEDURE IF EXISTS SP_UPDATE_USUARIO;
DELIMITER //
CREATE PROCEDURE SP_UPDATE_USUARIO(
$NOMBRE VARCHAR(100),
$APELLIDO VARCHAR(100),
$RUT INT(8),
$DV CHAR(1),
$TIPO_USUARIO INT,
$TIPO_PERSONA INT,
$NOMBRE_FANTASIA VARCHAR(100),
$COMUNA INT,
$CODIGO_POSTAL INT,
$TELEFONO INT,
$CORREO VARCHAR(100),
$CONTRASENA VARCHAR(255)
)
BEGIN
	DECLARE $ID_USUARIO INT;
    #OBTENER ID DE USUARIO
    SELECT
    ID_USUARIO INT $ID_USUARIO
    FROM PERSONA
    WHERE RUT=$RUT;
    #ACTUALIZAR DATOS PERSONA
    UPDATE PERSONA(
    RUT,
    DIGITO_VERIFICADOR,
    NOMBRE,
    APELLIDO,
    NOMBRE_FANTASIA,
    CODIGO_POSTAL,
    ID_COMUNA,
    TELEFONO,
    ID_TITPO_PERSONA_LEGAL)
    SET (
	$RUT,
    $DV,
    $NOMBRE,
    $APELLIDO,
    $NOMBRE_FANTASIA,
    $CODIGO_POSTAL,
    $COMUNA,
    $TELEFONO,
    $TIPO_PERSONA
    )
    #ACTUALIZAR DATOS USUARIO
    UPDATE USUARIO(
    CORREO,
    CONTRASENA,
    ID_PERFIL
    )
    SET(
	$CORREO,
    $CONTRASENA,
    $TIPO_USUARIO
    )
END
DELIMITER ;
